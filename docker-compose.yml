version: '2'

services:
    consul:
        image: gliderlabs/consul-server
        command: -bootstrap -bind=127.0.0.1 -recursor=8.8.8.8
        ports:
        - 8400:8400
        - 8500:8500
        - 8600:8600/udp
        # - 53:8600/udp -> Use this to bind consul to the DNS port and use DNS resolution
    registrator:
        image: gliderlabs/registrator
        depends_on:
        - consul
        network_mode: host
        volumes:
        - /var/run/docker.sock:/tmp/docker.sock
        command: consul://localhost:8500

    # This is a standard consul-template usage
    # Autoconfigured haproxy
    consul-template-haproxy:
        build:
            context: .
            dockerfile: Dockerfile-haproxy
        depends_on:
        - consul
        network_mode: host
        ports:
        - 80:80
        - 443:443
        volumes:
        - ./dump:/app/dump
        - /etc/haproxy
        - /etc/consul-template
        - ./templates/haproxy.cnf.njk:/app/templates/haproxy.cnf.njk
        environment:
        - 'NODE_CONFIG={"consul":{"host":"127.0.0.1"},"templates":[{"source":"templates/haproxy.cnf.njk","path":"dump","filename":"haproxy.cfg","command":"haproxy -D -p /var/run/haproxy.pid  -f /app/dump/haproxy.cfg -sf $$(cat /var/run/haproxy.pid) || true" }]}'

    cerbot-consul-server:
        image: gtrias/cerbot-consul-server
        network_mode: host
        ports:
        - 54321:54321
        environment:
        - 'NODE_CONFIG={"consul":{"host":"127.0.0.1"}}'

    # Testing containers
    whoami1:
        image: emilevauge/whoami
        ports:
        - 80
        environment:
        - 'SERVICE_TAGS=VIRTUAL_HOST=whoami.example.com,SSL_VIRTUAL_HOST=whoami.example.com,SSL_EMAIL=info@example.com'
    whoami2:
        image: emilevauge/whoami
        ports:
        - 80
        environment:
        - 'SERVICE_TAGS=VIRTUAL_HOST=whoami.example.com,SSL_VIRTUAL_HOST=whoami.example.com,SSL_EMAIL=info@example.com'
    whoami3:
        image: emilevauge/whoami
        ports:
        - 80
        environment:
        - 'SERVICE_TAGS=VIRTUAL_HOST=whoami.example.com,SSL_VIRTUAL_HOST=whoami.example.com,SSL_EMAIL=info@example.com'
